{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "target": {
          "limit": 100,
          "matchAny": false,
          "tags": [],
          "type": "dashboard"
        },
        "type": "dashboard"
      }
    ]
  },
  "description": "",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 1,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 36,
      "panels": [],
      "title": "App Usage Report",
      "type": "row"
    },
    {
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 1
      },
      "id": 15,
      "options": {
        "activeTheme": "Custom",
        "disableThemePicker": true,
        "themes": [
          {
            "name": "Custom",
            "styles": [
              {
                "props": {
                  "theme": "default"
                },
                "type": "basetheme"
              },
              {
                "props": {
                  "url": ""
                },
                "type": "bgimage"
              },
              {
                "props": {
                  "url": ""
                },
                "type": "url"
              },
              {
                "props": {
                  "text": ".css-1ejir9x {\n  line-height: 28px;\n  padding-left: 2px;\n  padding-right: 2px;\n}\n.css-nx8q14 {\n  letter-spacing: 0;\n}\n.css-nx8q14 svg {\n  overflow: inherit\n}\n.scrollbar-view {\n  margin-top: 12px;\n}"
                },
                "type": "style"
              }
            ]
          }
        ]
      },
      "pluginVersion": "0.2.1",
      "targets": [
        {
          "format": "time_series",
          "group": [],
          "metricColumn": "none",
          "rawQuery": false,
          "rawSql": "SELECT\n  created_at AS \"time\",\n  latitude\nFROM facilities\nWHERE\n  $__timeFilter(created_at)\nORDER BY 1",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "latitude"
                ],
                "type": "column"
              }
            ]
          ],
          "table": "facilities",
          "timeColumn": "created_at",
          "timeColumnType": "timestamp",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "Summary of visits to the Youth Health App",
      "transparent": true,
      "type": "yesoreyeram-boomtheme-panel"
    },
    {
      "description": "Total number of registered app users",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "blue",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 8,
        "x": 0,
        "y": 2
      },
      "id": 7,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "/.*/",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.1.4",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "SELECT COUNT(DISTINCT u.id)\nFROM app_users u\nLEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\nWHERE u.deleted_at IS NULL\n  AND u.age BETWEEN ${age:raw}\n  AND u.platform IN ($platform)\n  AND COALESCE(u.province_id, '') IN ($province_id)\n  AND COALESCE(u.gender, '') IN (${gender:raw})\n  AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n  AND $__timeFilter(u.registered_at)",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# App Users",
      "type": "stat"
    },
    {
      "description": "Total number of open App (count as soon as the app is opened, and count every 30-minute interval)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "orange",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 8,
        "x": 8,
        "y": 2
      },
      "id": 6,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "/.*/",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.1.4",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT u.id\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n)\n\nSELECT COUNT(*)\nFROM visits v\nINNER JOIN pages p ON v.page_id = p.id\nINNER JOIN _app_users u ON v.app_user_id = u.id\nWHERE $__timeFilter(v.visit_date)\n  AND p.parent_id IS NULL\n  AND p.code = 'app_visit';",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# App Accessed",
      "type": "stat"
    },
    {
      "description": "Total visits of the main categories(Home page menu, and count every 30-minute interval)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 8,
        "x": 16,
        "y": 2
      },
      "id": 17,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "/.*/",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.1.4",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT u.id\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n)\n\nSELECT COUNT(*)\nFROM visits v\nINNER JOIN pages p ON v.page_id = p.id\nINNER JOIN _app_users u ON v.app_user_id = u.id\nWHERE $__timeFilter(v.visit_date)\n  AND p.parent_id IS NULL\n  AND p.code != 'app_visit';",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Visits of Main Category",
      "type": "stat"
    },
    {
      "description": "ផែនទីអ្នកប្រើប្រាស់កម្មវិធីសុខភាពយុវជន (Map of app users)",
      "gridPos": {
        "h": 13,
        "w": 12,
        "x": 0,
        "y": 6
      },
      "id": 13,
      "options": {
        "ant": {
          "color": "rgb(0, 100, 255)",
          "delay": 400,
          "paused": false,
          "pulseColor": "rgb(0, 0, 0)",
          "reverse": false,
          "weight": 5
        },
        "coordinates": {
          "customLatitudeColumnName": "",
          "customLongitudeColumnName": ""
        },
        "discardZeroOrNull": true,
        "geospatial": {
          "boxZoom": false,
          "doubleClickZoom": false,
          "geoJsonUrl": "http://localhost:3000/provinces.json",
          "scrollWheelZoom": false,
          "touchZoom": false
        },
        "heat": {
          "fitBoundsOnLoad": false,
          "fitBoundsOnUpdate": false
        },
        "hex": {
          "colorRangeFrom": "#f7fbff",
          "colorRangeTo": "#ff0000",
          "opacity": 0.6,
          "radiusRangeFrom": 5,
          "radiusRangeTo": 12
        },
        "map": {
          "centerLatitude": 12.564,
          "centerLongitude": 104.991,
          "tileUrlSchema": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          "useBoundsInQuery": false,
          "useCenterFromFirstPos": false,
          "useCenterFromLastPos": false,
          "zoom": 7,
          "zoomToDataBounds": false
        },
        "marker": {
          "alwaysShowTooltips": true,
          "showOnlyLastMarker": false,
          "size": 25,
          "sizeLast": 25,
          "useSecondaryIconForAllMarkers": false,
          "useSecondaryIconForLastMarker": false
        },
        "viewType": "geospatial"
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT(u.id), u.registered_at, u.province_id\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n)\n\nSELECT\n  CONCAT('# User in <b>', l.name_en, '</b> (', count(*), ')') as popup,\n  l.latitude as latitude,\n  l.longitude as longitude,\n  count(*)::text as tooltip\nFROM _app_users au\nINNER JOIN locations l ON au.province_id = l.id\nWHERE $__timeFilter(au.registered_at)\nGROUP BY l.id;",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "latitude"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "table": "facilities",
          "timeColumn": "created_at",
          "timeColumnType": "timestamp",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Users on Map",
      "type": "alexandra-trackmap-panel"
    },
    {
      "description": "Count unique user visits every 30-minute interval within the last 7 days",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "blue",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 12,
        "y": 6
      },
      "id": 18,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "/.*/",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.1.4",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _joined_app_users AS (\n  SELECT\n    u.id,\n    u.age,\n    (CASE WHEN c.id is not null THEN c.id::text ELSE '' END) as profile_id,\n    (CASE WHEN u.province_id is not null THEN u.province_id ELSE '' END) as province_id,\n    (CASE WHEN u.gender is not null THEN u.gender ELSE '' END) as gender,\n    u.platform\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  LEFT JOIN characteristics c ON ac.characteristic_id = c.id\n  WHERE u.deleted_at is NULL\n),\n_app_users AS (\n  SELECT * \n  FROM app_users \n  WHERE id IN (\n    SELECT fu.id\n    FROM _joined_app_users fu\n    WHERE \n      fu.province_id in ($province_id)\n      AND fu.age BETWEEN ${age:raw}\n      AND fu.gender in (${gender:raw})\n      AND fu.profile_id in ($characteristic_id)\n      AND fu.platform in ($platform)\n  )\n),\n_end_date AS (\n  select TIMESTAMP 'epoch' + (SELECT $__to) * INTERVAL '1 millisecond'\n),\n_start_date AS (\n  select TIMESTAMP 'epoch' + (SELECT $__to - 604800000) * INTERVAL '1 millisecond'\n)\n\nSELECT\n  count(distinct(v.app_user_id))\nFROM visits v\nINNER JOIN _app_users u ON v.app_user_id = u.id\nWHERE visit_date BETWEEN (select * from _start_date) AND (select * from _end_date)\nAND $__timeFilter(visit_date)",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Last 7 day visits",
      "type": "stat"
    },
    {
      "description": "Count unique user visits every 30-minute interval within the last 30 days",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "blue",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 16,
        "y": 6
      },
      "id": 31,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "/.*/",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.1.4",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT u.id\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n),\n_end_date AS (\n  select TIMESTAMP 'epoch' + (SELECT $__to) * INTERVAL '1 millisecond'\n),\n_start_date AS (\n  select TIMESTAMP 'epoch' + (SELECT $__to - 2592000000) * INTERVAL '1 millisecond'\n)\n\nSELECT\n  count(distinct(v.app_user_id))\nFROM visits v\nINNER JOIN _app_users u ON v.app_user_id = u.id\nWHERE visit_date BETWEEN (select * from _start_date) AND (select * from _end_date)\nAND $__timeFilter(visit_date)",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Last 30 days visits",
      "type": "stat"
    },
    {
      "description": "Count unique user visits every 30-minute interval within the last 90 days",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "blue",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 4,
        "x": 20,
        "y": 6
      },
      "id": 20,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "/.*/",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.1.4",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT u.id\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n),\n_end_date AS (\n  select TIMESTAMP 'epoch' + (SELECT $__to) * INTERVAL '1 millisecond'\n),\n_start_date AS (\n  select TIMESTAMP 'epoch' + (SELECT $__to - 7776000000) * INTERVAL '1 millisecond'\n)\n\nSELECT\n  count(distinct(v.app_user_id))\nFROM visits v\nINNER JOIN _app_users u ON v.app_user_id = u.id\nWHERE visit_date BETWEEN (select * from _start_date) AND (select * from _end_date)\nAND $__timeFilter(visit_date)",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Last 90 days visits",
      "type": "stat"
    },
    {
      "description": "ចំនួនអ្នកប្រើប្រាស់កម្មវិធីបែងចែកតាមខេត្ត (Number of app users by province)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "left",
            "cellOptions": {
              "type": "auto"
            },
            "filterable": false,
            "inspect": false
          },
          "decimals": 1,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "locale"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 12,
        "x": 12,
        "y": 10
      },
      "id": 26,
      "options": {
        "cellHeight": "sm",
        "footer": {
          "countRows": false,
          "enablePagination": true,
          "fields": "",
          "reducer": [
            "sum"
          ],
          "show": false
        },
        "showHeader": true
      },
      "pluginVersion": "10.1.4",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT(u.id), u.province_id, u.registered_at\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n)\n\nSELECT\n  concat_ws(' ', l.name_en, '(', l.name_km, ')') as \"Province\",\n  count(*) as \"# of users\"\nFROM _app_users au\nINNER JOIN locations l ON au.province_id = l.id\nWHERE $__timeFilter(au.registered_at)\nGROUP BY l.id\nORDER BY count(*) DESC;",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "latitude"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "table": "facilities",
          "timeColumn": "created_at",
          "timeColumnType": "timestamp",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Users by Provinces",
      "type": "table"
    },
    {
      "description": "ចំនួនអ្នកប្រើប្រាស់កម្មវិធីបែងចែកតាម Platform (Number of app user by platform)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "unit": "locale"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 19
      },
      "id": 28,
      "options": {
        "displayLabels": [
          "name",
          "value"
        ],
        "legend": {
          "displayMode": "list",
          "placement": "right",
          "showLegend": true
        },
        "pieType": "donut",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "/^count$/",
          "values": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT(u.id), u.registered_at, u.platform\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n)\n\nSELECT \n  (CASE WHEN platform = 1 THEN 'Android' ELSE 'iOs' END) as platform, \n  count(*)\nFROM _app_users u\nWHERE $__timeFilter(u.registered_at)\nGROUP BY u.platform",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "latitude"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "table": "facilities",
          "timeColumn": "created_at",
          "timeColumnType": "timestamp",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# User by platform",
      "type": "piechart"
    },
    {
      "description": "ចំនួនអ្នកប្រើប្រាស់កម្មវិធីបែងចែកតាមភេទ (Number of app users by gender)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "unit": "locale"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Page 2"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#56A64B",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "អនាមិក"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "អត់ដឹង"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#4200fa",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "ស្រី"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "purple",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Female"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "purple",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Male"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Anonymous"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "LGBT+"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Unknown"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "red",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 19
      },
      "id": 16,
      "options": {
        "displayLabels": [
          "name",
          "value"
        ],
        "legend": {
          "displayMode": "list",
          "placement": "right",
          "showLegend": true,
          "values": []
        },
        "pieType": "donut",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "/^count$/",
          "values": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT \n    DISTINCT(u.id), \n    u.registered_at,\n    (\n      CASE \n        WHEN gender = 'male' THEN 'Male'\n        WHEN gender = 'female' THEN 'Female'\n        WHEN gender = 'lgbt' THEN 'LGBT+'\n        WHEN gender = 'unknown' THEN 'Unknown'\n        ELSE 'Anonymous'\n      END\n    ) as gender_en\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n)\n\nSELECT u.gender_en, count(*)\nFROM _app_users u\nWHERE $__timeFilter(u.registered_at)\nGROUP BY u.gender_en",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Users by Gender",
      "type": "piechart"
    },
    {
      "description": "ចំនួនអ្នកប្រើប្រាស់កម្មវិធីបែងចែកតាមអាយុ (Number of app users by age range)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "unit": "locale"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Page 2"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#56A64B",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "អនាមិក"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Age 25 - 30"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#1500fa",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Anonymous"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 27
      },
      "id": 8,
      "options": {
        "displayLabels": [
          "name",
          "value"
        ],
        "legend": {
          "displayMode": "list",
          "placement": "right",
          "showLegend": true,
          "values": []
        },
        "pieType": "donut",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "/^count$/",
          "values": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT \n    DISTINCT(u.id), \n    u.registered_at,\n    (\n      CASE \n        WHEN age > 30 THEN 'Age > 30'\n        WHEN age > 24 THEN 'Age 25 - 30'\n        WHEN age > 17 THEN 'Age 18 - 24'\n        WHEN age > 14 THEN 'Age 15 - 17'\n        WHEN age > 9 THEN 'Age 10 - 14'\n        WHEN age > 0 THEN 'Age < 10'\n        ELSE 'Anonymous'\n      END\n    ) as age_range\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n)\n\nSELECT\n  au.age_range,\n  COUNT(*)\nFROM _app_users au\nWHERE\n  $__timeFilter(au.registered_at)\nGROUP BY au.age_range\n",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Users by Age Range",
      "type": "piechart"
    },
    {
      "description": "ចំនួនអ្នកប្រើប្រាស់កម្មវិធីបែងចែកតាមលក្ខណៈសម្បត្តិ (Number of app users by profile)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "unit": "locale"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Page 2"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#56A64B",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "មិនកំណត់/អនាមិក"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Unknown/Anonymous"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "ជនជាតិដើម"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "__systemRef": "hideSeriesFrom",
            "matcher": {
              "id": "byNames",
              "options": {
                "mode": "exclude",
                "names": [
                  "count"
                ],
                "prefix": "All except:",
                "readOnly": true
              }
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": false,
                  "tooltip": false,
                  "viz": true
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "មានប័ណ្ណសមធម៌(ប័ណ្ណក្រីក្រ)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "ជនមានពិការភាព"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "purple",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 27
      },
      "id": 9,
      "options": {
        "displayLabels": [
          "name",
          "value"
        ],
        "legend": {
          "displayMode": "list",
          "placement": "right",
          "showLegend": true,
          "values": []
        },
        "pieType": "donut",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT \n    u.id, \n    u.registered_at,\n    COALESCE(c.name_en, 'Unknown/Anonymous') as profile\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  LEFT JOIN characteristics c ON ac.characteristic_id = c.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n)\n\nSELECT \n  u.profile,\n  count(*)\nFROM _app_users u\nWHERE $__timeFilter(u.registered_at)\nGROUP BY u.profile",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Users by Profile",
      "type": "piechart"
    },
    {
      "description": "ចំនួនអ្នកប្រើប្រាស់កម្មវិធីបែងចែកតាមមុខរបរ (Number of app users by occupation)\nNote: N/A refers to anonymous.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "unit": "locale"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Page 2"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#56A64B",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "មិនកំណត់/អនាមិក"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Unknown/Anonymous"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "ជនជាតិដើម"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "__systemRef": "hideSeriesFrom",
            "matcher": {
              "id": "byNames",
              "options": {
                "mode": "exclude",
                "names": [
                  "count"
                ],
                "prefix": "All except:",
                "readOnly": true
              }
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": false,
                  "tooltip": false,
                  "viz": true
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "មានប័ណ្ណសមធម៌(ប័ណ្ណក្រីក្រ)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "ជនមានពិការភាព"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "purple",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 35
      },
      "id": 34,
      "options": {
        "displayLabels": [
          "name",
          "value"
        ],
        "legend": {
          "displayMode": "list",
          "placement": "right",
          "showLegend": true,
          "values": []
        },
        "pieType": "donut",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _joined_app_users AS (\n  SELECT\n    u.id,\n    u.age,\n    (CASE WHEN c.id is not null THEN c.id::text ELSE '' END) as profile_id,\n    (CASE WHEN u.province_id is not null THEN u.province_id ELSE '' END) as province_id,\n    (CASE WHEN u.gender is not null THEN u.gender ELSE '' END) as gender,\n    u.platform\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  LEFT JOIN characteristics c ON ac.characteristic_id = c.id\n  WHERE u.deleted_at is NULL\n)\n\nSELECT\n  (\n    CASE \n      WHEN u.occupation = 0 THEN 'N/A(anonymous)'\n      WHEN u.occupation = 1 THEN 'Student'\n      WHEN u.occupation = 2 THEN 'Entertainment worker'\n      WHEN u.occupation = 3 THEN 'Factory worker'\n      WHEN u.occupation = 4 THEN 'Local migrant worker'\n      WHEN u.occupation = 5 THEN 'Oversea migrant worker'\n      WHEN u.occupation = 6 THEN 'Other'\n      ELSE 'Anonymous'\n    END\n  ) as occupation,\n  count(*)\nFROM app_users u\nWHERE \n  id IN (\n    SELECT distinct(fu.id)\n    FROM _joined_app_users fu\n    WHERE \n      fu.province_id in ($province_id)\n      AND fu.age BETWEEN ${age:raw}\n      AND fu.gender in (${gender:raw})\n      AND fu.profile_id in ($characteristic_id)\n      AND fu.platform in ($platform)\n  )\n  AND $__timeFilter(u.registered_at)\nGROUP BY u.occupation;",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Users by Occupation",
      "type": "piechart"
    },
    {
      "description": "ចំនួនអ្នកប្រើប្រាស់កម្មវិធីបែងចែកតាមកម្រិតវប្បធម៌(Number of app users by education level) \nNote: N/A refers to anonymous.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "unit": "locale"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Page 2"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#56A64B",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "មិនកំណត់/អនាមិក"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Unknown/Anonymous"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "ជនជាតិដើម"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "__systemRef": "hideSeriesFrom",
            "matcher": {
              "id": "byNames",
              "options": {
                "mode": "exclude",
                "names": [
                  "count"
                ],
                "prefix": "All except:",
                "readOnly": true
              }
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": false,
                  "tooltip": false,
                  "viz": true
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "មានប័ណ្ណសមធម៌(ប័ណ្ណក្រីក្រ)"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "ជនមានពិការភាព"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "purple",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 35
      },
      "id": 35,
      "options": {
        "displayLabels": [
          "name",
          "value"
        ],
        "legend": {
          "displayMode": "list",
          "placement": "right",
          "showLegend": true,
          "values": []
        },
        "pieType": "donut",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _joined_app_users AS (\n  SELECT\n    u.id,\n    u.age,\n    (CASE WHEN c.id is not null THEN c.id::text ELSE '' END) as profile_id,\n    (CASE WHEN u.province_id is not null THEN u.province_id ELSE '' END) as province_id,\n    (CASE WHEN u.gender is not null THEN u.gender ELSE '' END) as gender,\n    u.platform\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  LEFT JOIN characteristics c ON ac.characteristic_id = c.id\n  WHERE u.deleted_at is NULL\n)\n\nSELECT\n  (\n    CASE \n      WHEN u.education_level = 0 THEN 'N/A(anonymous)'\n      WHEN u.education_level = 1 THEN 'General knowledge'\n      WHEN u.education_level = 2 THEN 'University'\n      WHEN u.education_level = 3 THEN 'TVET'\n      WHEN u.education_level = 4 THEN 'Dropout student'\n      ELSE 'Anonymous'\n    END\n  ) as education_level,\n  count(*)\nFROM app_users u\nWHERE \n  id IN (\n    SELECT distinct(fu.id)\n    FROM _joined_app_users fu\n    WHERE \n      fu.province_id in ($province_id)\n      AND fu.age BETWEEN ${age:raw}\n      AND fu.gender in (${gender:raw})\n      AND fu.profile_id in ($characteristic_id)\n      AND fu.platform in ($platform)\n  )\n  AND $__timeFilter(u.registered_at)\nGROUP BY u.education_level;",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Users by Education level",
      "type": "piechart"
    },
    {
      "description": "ចំនួនការចូលទស្សនាទំព័រមុខ (At least visit one among home, services, .. etc.)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "unit": "locale"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Understand Reproductive Health"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-red",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Educational Video"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Health Clinic"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "FAQ"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-green",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Understanding gender"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Mental Support Services"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-purple",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Drug and Alcohol Prevention"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Understanding HIV and STIs"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Youth Migration"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "__systemRef": "hideSeriesFrom",
            "matcher": {
              "id": "byNames",
              "options": {
                "mode": "exclude",
                "names": [
                  "count",
                  "Youth Migration",
                  "Understanding HIV and STIs"
                ],
                "prefix": "All except:",
                "readOnly": true
              }
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "legend": false,
                  "tooltip": false,
                  "viz": true
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 43
      },
      "id": 4,
      "options": {
        "displayLabels": [
          "name",
          "value"
        ],
        "legend": {
          "displayMode": "list",
          "placement": "right",
          "showLegend": true,
          "values": []
        },
        "pieType": "donut",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT(u.id)\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n),\nmain_page_codes AS (\n  SELECT * FROM (VALUES('video'), ('service'), ('catg_lvl_1_reprod_health'), ('help'), ('catg_lvl_1_understanding_gender'), ('catg_lvl_1_drug_and_alcohol_prevention'), ('catg_lvl_1_understanding_hiv_and_stis'), ('catg_lvl_1_youth_migration'), ('mental_support')) t(c)\n)\n\nSELECT\n  p.name_en as page_name,\n  count(*)\nFROM visits v\nINNER JOIN pages p ON v.page_id = p.id\nINNER JOIN _app_users u ON v.app_user_id = u.id\nWHERE \n  $__timeFilter(v.visit_date)\n  AND p.viz_code in (SELECT * FROM main_page_codes)\n  AND p.parent_id is null\nGROUP BY p.viz_code, p.name_en\nORDER BY array_position(ARRAY(SELECT * FROM main_page_codes), p.viz_code);",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Visits on Each Category",
      "type": "piechart"
    },
    {
      "description": "ចំនួនអ្នកចុចទាក់ទងសេវាគាំទ្រផ្លូវចិត្ត 1280 (# of initial contact to 1280)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "unit": "locale"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Telegram"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Hotline"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Messenger"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "purple",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "SMS"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 43
      },
      "id": 23,
      "options": {
        "displayLabels": [
          "name",
          "value"
        ],
        "legend": {
          "displayMode": "list",
          "placement": "right",
          "showLegend": true,
          "values": []
        },
        "pieType": "donut",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT(u.id)\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n)\n\nSELECT\n  p.name_km as page_name,\n  count(*)\nFROM visits v\nINNER JOIN pages p ON v.page_id = p.id\nINNER JOIN _app_users u ON v.app_user_id = u.id\nWHERE \n  $__timeFilter(v.visit_date)\n  AND p.code in ('messenger', 'telegram', 'phone', 'sms')\nGROUP BY p.name_km;",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "Initial Contact to 1280",
      "type": "piechart"
    },
    {
      "description": "ចំនួនការចូលទស្សនាទំព័រមុខបែងចែកតាមខែ (At least visit one among home, services, .. etc.)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "left",
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "blue",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Understand Reproductive Health"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-red",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Educational Video"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Health Clinic"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "FAQ"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-green",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Understanding Gender"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Mental Support Services"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-purple",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Drug and Alcohol Prevention"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Understanding HIV and STIs"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Youth Migration"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-yellow",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 51
      },
      "id": 2,
      "options": {
        "barRadius": 0,
        "barWidth": 0.97,
        "fullHighlight": false,
        "groupWidth": 0.7,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "mode": "single",
          "sort": "none"
        },
        "xTickLabelRotation": -45,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "9.0.6",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT(u.id)\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n),\n_visit_pages AS (\n  SELECT\n    v.visit_date,\n    p.viz_code\n  FROM visits v\n  INNER JOIN pages p ON v.page_id = p.id\n  INNER JOIN _app_users u ON v.app_user_id = u.id\n  WHERE \n    $__timeFilter(v.visit_date)\n    AND p.parent_id is null\n    AND p.viz_code != 'app_visit'\n)\n\nSELECT \n  to_char(DATE_TRUNC('month', v.visit_date), 'Mon-YY') AS visit_to_month,\n  count(case when v.viz_code='video' then 1 end) AS \"Educational Video\",\n  count(case when v.viz_code='service' then 1 end) AS \"Health Clinic\",\n  count(case when v.viz_code='catg_lvl_1_reprod_health' then 1 end) AS \"Understand Reproductive Health\",\n  count(case when v.viz_code='help' then 1 end) AS \"FAQ\",\n  count(case when v.viz_code='catg_lvl_1_understanding_gender' then 1 end) AS \"Understanding Gender\",\n  count(case when v.viz_code='catg_lvl_1_drug_and_alcohol_prevention' then 1 end) AS \"Drug and Alcohol Prevention\",\n  count(case when v.viz_code='catg_lvl_1_understanding_hiv_and_stis' then 1 end) AS \"Understanding HIV and STIs\",\n  count(case when v.viz_code='catg_lvl_1_youth_migration' then 1 end) AS \"Youth Migration\",\n  count(case when v.viz_code='mental_support' then 1 end) AS \"Mental Support Services\"\nFROM _visit_pages v\nGROUP BY DATE_TRUNC('month', v.visit_date);",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "# Visits on Each Category by Month",
      "type": "barchart"
    },
    {
      "description": "ចំនួនអ្នកចុចទាក់ទងសេវាគាំទ្រផ្លូវចិត្ត 1280 បែងចែកតាមខែ (Number of initial contact to 1280 by month)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "blue",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Telegram"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Hotline"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Messenger"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "purple",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "SMS"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "orange",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 60
      },
      "id": 24,
      "options": {
        "barRadius": 0,
        "barWidth": 0.97,
        "fullHighlight": false,
        "groupWidth": 0.7,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "mode": "single",
          "sort": "none"
        },
        "xTickLabelRotation": -45,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "9.0.6",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT(u.id)\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n),\n_visit_pages AS (\n  SELECT\n    v.visit_date,\n    p.code\n  FROM visits v\n  INNER JOIN pages p ON v.page_id = p.id\n  INNER JOIN _app_users u ON v.app_user_id = u.id\n  WHERE \n    $__timeFilter(v.visit_date)\n    AND p.code in ('messenger', 'telegram', 'phone', 'sms')    \n)\n\nSELECT \n  to_char(DATE_TRUNC('month', v.visit_date), 'Mon-YY') AS visit_to_month,\n  count(case when v.code='telegram' then 1 end) AS \"Telegram\",\n  count(case when v.code='phone' then 1 end) AS \"Hotline\",\n  count(case when v.code='messenger' then 1 end) AS \"Messenger\",\n  count(case when v.code='sms' then 1 end) AS \"SMS\"\nFROM _visit_pages v\nGROUP BY DATE_TRUNC('month', v.visit_date);",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "timeColumn": "time",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "Initial Contact to 1280 by Month",
      "type": "barchart"
    },
    {
      "description": "ចំនួនចូលទស្សនាប្រធានបទសំណួរច្រើនជាងគេទាំង 10 (Top 10 most visited topics)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "opacity",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "locale"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "count"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "#56A64B",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 69
      },
      "id": 22,
      "options": {
        "barRadius": 0,
        "barWidth": 0.97,
        "fullHighlight": false,
        "groupWidth": 0.7,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "orientation": "horizontal",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "mode": "single",
          "sort": "none"
        },
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT(u.id)\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n)\n\nSELECT\n  t.name_en,\n  count(*) as \"# of visits\"\nFROM visits v\nINNER JOIN _app_users u ON v.app_user_id = u.id\nINNER JOIN topics t ON v.pageable_id = t.id\nWHERE \n  $__timeFilter(v.visit_date)\n  AND v.pageable_type = 4\nGROUP BY t.name_en\nORDER BY count(*) DESC\nLIMIT 10;\n",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "latitude"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "table": "facilities",
          "timeColumn": "created_at",
          "timeColumnType": "timestamp",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "Top 10 Most Visited Topics",
      "type": "barchart"
    },
    {
      "description": "និន្នាការអ្នកចុះឈ្មោះប្រើប្រាស់កម្មវិធី \"សុខភាពយុវជន\" (User registration trend)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "blue",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Total user"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 78
      },
      "id": 30,
      "options": {
        "barRadius": 0,
        "barWidth": 0.97,
        "fullHighlight": false,
        "groupWidth": 0.7,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "mode": "single",
          "sort": "none"
        },
        "xTickLabelRotation": -45,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "9.2.1",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT(u.id), u.registered_at\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n    AND $__timeFilter(u.registered_at)\n)\n\nSELECT \n  to_char(DATE_TRUNC('month', u.registered_at), 'Mon-YY') AS user_to_month,\n  count(*) as \"Total user\"\nFROM _app_users u\nGROUP BY DATE_TRUNC('month', u.registered_at);",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "latitude"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "table": "facilities",
          "timeColumn": "created_at",
          "timeColumnType": "timestamp",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "User Registration Trend",
      "type": "barchart"
    },
    {
      "description": "និន្នាការអ្នកចុះឈ្មោះប្រើប្រាស់កម្មវិធី \"សុខភាពយុវជន\" (User registration trend)",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "opacity",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "blue",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Total user"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "blue",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 87
      },
      "id": 32,
      "options": {
        "barRadius": 0,
        "barWidth": 0.97,
        "fullHighlight": false,
        "groupWidth": 0.7,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "mode": "single",
          "sort": "none"
        },
        "xTickLabelRotation": -45,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "9.2.1",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "group": [],
          "metricColumn": "none",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT DISTINCT(u.id), u.registered_at, u.gender\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n    AND $__timeFilter(u.registered_at)\n)\n\nSELECT \n  to_char(DATE_TRUNC('month', u.registered_at), 'Mon-YY') AS user_to_month,\n  SUM(CASE u.gender WHEN 'male' THEN 1 ELSE 0 END) as \"Male\",\n  SUM(CASE u.gender WHEN 'female' THEN 1 ELSE 0 END) as \"Female\",\n  SUM(CASE u.gender WHEN 'lgbt' THEN 1 ELSE 0 END) as \"LGBT+\",\n  SUM(CASE u.gender WHEN 'unknown' THEN 1 ELSE 0 END) as \"Unknown\",\n  SUM(CASE WHEN u.gender is null THEN 1 ELSE 0 END) as \"Anonymous\"\nFROM _app_users u\nGROUP BY DATE_TRUNC('month', u.registered_at);",
          "refId": "A",
          "select": [
            [
              {
                "params": [
                  "latitude"
                ],
                "type": "column"
              }
            ]
          ],
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "table": "facilities",
          "timeColumn": "created_at",
          "timeColumnType": "timestamp",
          "where": [
            {
              "name": "$__timeFilter",
              "params": [],
              "type": "macro"
            }
          ]
        }
      ],
      "title": "User Registration Trend by Gender",
      "type": "barchart"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 96
      },
      "id": 37,
      "panels": [],
      "title": "Survey Report",
      "type": "row"
    },
    {
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            },
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 97
      },
      "id": 38,
      "options": {
        "cellHeight": "sm",
        "footer": {
          "countRows": false,
          "fields": "",
          "reducer": [
            "sum"
          ],
          "show": false
        },
        "showHeader": true
      },
      "pluginVersion": "10.1.4",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "WITH _joined_app_users AS (\n  SELECT\n    u.id,\n    u.age,\n    (CASE WHEN c.id is not null THEN c.id::text ELSE '' END) as profile_id,\n    (CASE WHEN u.province_id is not null THEN u.province_id ELSE '' END) as province_id,\n    (CASE WHEN u.gender is not null THEN u.gender ELSE '' END) as gender,\n    u.platform\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  LEFT JOIN characteristics c ON ac.characteristic_id = c.id\n  WHERE u.deleted_at is NULL\n),\n_app_users AS (\n  SELECT \n    *,\n    (\n      CASE \n        WHEN gender = 'male' THEN 'Male'\n        WHEN gender = 'female' THEN 'Female'\n        WHEN gender = 'lgbt' THEN 'LGBT+'\n        WHEN gender = 'unknown' THEN 'Unknown'\n        ELSE 'Anonymous'\n      END\n    ) as gender_en\n  FROM app_users \n  WHERE id IN (\n    SELECT distinct(fu.id)\n    FROM _joined_app_users fu\n    WHERE \n      fu.province_id in ($province_id)\n      AND fu.age BETWEEN ${age:raw}\n      AND fu.gender in (${gender:raw})\n      AND fu.profile_id in ($characteristic_id)\n      AND fu.platform in ($platform)\n  )\n),\ntracking_questions AS (\n  SELECT \n    q.id, \n    s.topic_id as topic_id,\n    ROW_NUMBER() OVER(PARTITION BY s.topic_id ORDER BY q.display_order ASC) AS row\n  FROM questions q\n  JOIN sections s ON q.section_id = s.id\n  WHERE q.tracking = true\n  ORDER BY q.display_order\n),\ntracking_answers AS (\n  SELECT \n    q.id,\n    q.topic_id,\n    t.name,\n    sa.value,\n    q.row\n  FROM survey_answers sa\n  JOIN tracking_questions q ON sa.question_id = q.id\n  JOIN taggings tg ON tg.taggable_id = q.id AND tg.taggable_type = 'Question'\n  JOIN tags t ON tg.tag_id = t.id\n  JOIN surveys s ON sa.survey_id = s.id\n  JOIN _app_users au ON s.app_user_id = au.id\n  WHERE\n    $__timeFilter(s.quizzed_at)\n),\nparticipants AS (\n  SELECT s.* \n  FROM surveys s\n  JOIN _app_users au ON s.app_user_id = au.id\n  WHERE\n    $__timeFilter(s.quizzed_at)\n)\n\nSELECT \n  f.name_en AS \"Survey\",\n  (select sum(n.success_count) from mobile_notifications n where n.topic_id = f.id) AS \"# of push notifications\",\n  (select count(*) from participants p where p.topic_id = f.id) AS \"# of participation\",\n  (\n    SELECT concat(sa.name, ' (', ARRAY_TO_STRING(array_agg(sa.answer), ', '), ')')\n    FROM (\n      SELECT ta.name, concat(ta.value, '=', count(*)) as answer\n      FROM tracking_answers ta\n      WHERE row = 1 AND topic_id = f.id\n      GROUP BY ta.name, ta.value\n    ) sa\n    GROUP BY sa.name\n  ) AS \"1st tracking\",\n  (\n    SELECT concat(sa.name, ' (', ARRAY_TO_STRING(array_agg(sa.answer), ', '), ')')\n    FROM (\n      SELECT ta.name, concat(ta.value, '=', count(*)) as answer\n      FROM tracking_answers ta\n      WHERE row = 2 AND topic_id = f.id\n      GROUP BY ta.name, ta.value\n    ) sa\n    GROUP BY sa.name\n  ) AS \"2nd tracking\"\nFROM topics f\nWHERE \n  f.type='Topics::SurveyForm' \n  AND f.published_at IS NOT NULL",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Survey Result",
      "type": "table"
    },
    {
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": []
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 105
      },
      "id": 39,
      "options": {
        "displayLabels": [
          "name",
          "percent",
          "value"
        ],
        "legend": {
          "displayMode": "list",
          "placement": "right",
          "showLegend": true
        },
        "pieType": "donut",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "WITH _app_users AS (\n  SELECT \n    DISTINCT(u.id), \n    u.registered_at,\n    (\n      CASE \n        WHEN gender = 'male' THEN 'Male'\n        WHEN gender = 'female' THEN 'Female'\n        WHEN gender = 'lgbt' THEN 'LGBT+'\n        WHEN gender = 'unknown' THEN 'Unknown'\n        ELSE 'Anonymous'\n      END\n    ) as gender_en\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  WHERE u.deleted_at IS NULL\n    AND u.age BETWEEN ${age:raw}\n    AND u.platform IN ($platform)\n    AND COALESCE(u.province_id, '') IN ($province_id)\n    AND COALESCE(u.gender, '') IN (${gender:raw})\n    AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n)\n\nSELECT\n  p.name_en,\n  count(*)\nFROM visits v\nJOIN pages p ON p.id = v.page_id\nINNER JOIN _app_users au ON au.id = v.app_user_id\nWHERE \n  $__timeFilter(v.visit_date)\n  AND p.parent_id is null\n  AND p.code IN ('open_remote_notification', 'open_in_app_notification')\nGROUP BY p.name_en",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "# Open notification",
      "type": "piechart"
    },
    {
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": []
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 105
      },
      "id": 40,
      "options": {
        "displayLabels": [
          "name",
          "percent",
          "value"
        ],
        "legend": {
          "displayMode": "list",
          "placement": "right",
          "showLegend": true
        },
        "pieType": "donut",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "WITH _joined_app_users AS (\n  SELECT\n    u.id,\n    u.age,\n    (CASE WHEN c.id is not null THEN c.id::text ELSE '' END) as profile_id,\n    (CASE WHEN u.province_id is not null THEN u.province_id ELSE '' END) as province_id,\n    (CASE WHEN u.gender is not null THEN u.gender ELSE '' END) as gender,\n    u.platform\n  FROM app_users u\n  LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n  LEFT JOIN characteristics c ON ac.characteristic_id = c.id\n  WHERE u.deleted_at is NULL\n),\n_app_users AS (\n  SELECT \n    *,\n    (\n      CASE \n        WHEN gender = 'male' THEN 'Male'\n        WHEN gender = 'female' THEN 'Female'\n        WHEN gender = 'lgbt' THEN 'LGBT+'\n        WHEN gender = 'unknown' THEN 'Unknown'\n        ELSE 'Anonymous'\n      END\n    ) as gender_en\n  FROM app_users \n  WHERE id IN (\n    SELECT distinct(fu.id)\n    FROM _joined_app_users fu\n    WHERE \n      fu.province_id in ($province_id)\n      AND fu.age BETWEEN ${age:raw}\n      AND fu.gender in (${gender:raw})\n      AND fu.profile_id in ($characteristic_id)\n      AND fu.platform in ($platform)\n  )\n)\n\nSELECT \n  INITCAP(au.gender_en),\n  count(*)\nFROM surveys s\nJOIN topics f ON s.topic_id = f.id\nJOIN _app_users au ON s.app_user_id = au.id\nWHERE\n  $__timeFilter(s.quizzed_at)\n  AND f.published_at IS NOT null\n  AND f.type = 'Topics::SurveyForm'\nGROUP BY au.gender_en;",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "# Participation by gender",
      "type": "piechart"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 113
      },
      "id": 43,
      "panels": [],
      "title": "Survey: Self-assessment for health education subjects",
      "type": "row"
    },
    {
      "description": "Survey Average Score for the topic: \"Self-assessment for health education subjects\"",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 11,
        "w": 5,
        "x": 0,
        "y": 114
      },
      "id": 42,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.1.4",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "WITH survey_results AS (\n    SELECT \n        sa.survey_id AS \"id\", \n        SUM(sa.value::integer) AS \"Total Score\"\n    FROM survey_answers sa\n    JOIN questions q ON q.id = sa.question_id\n    JOIN surveys s ON s.id = sa.survey_id\n    JOIN app_users u ON u.id = s.app_user_id\n    LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n    WHERE \n        s.topic_id = 'd56a6a45-9cdc-4af9-b1a6-550e58ad7bde'\n        AND $__timeFilter(s.quizzed_at)\n        AND u.deleted_at IS NULL\n        AND u.age BETWEEN ${age:raw}\n        AND u.platform IN ($platform)\n        AND COALESCE(u.province_id, '') IN ($province_id)\n        AND COALESCE(u.gender, '') IN (${gender:raw})\n        AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n    GROUP BY sa.survey_id, s.quizzed_at\n)\n\nSELECT AVG(\"Total Score\") FROM survey_results;",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Survey Average Score",
      "type": "stat"
    },
    {
      "description": "Survey result on the topic: \"Self-assessment for health education subjects\"",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            },
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 11,
        "w": 19,
        "x": 5,
        "y": 114
      },
      "id": 41,
      "options": {
        "cellHeight": "sm",
        "footer": {
          "countRows": false,
          "fields": "",
          "reducer": [
            "sum"
          ],
          "show": false
        },
        "showHeader": true,
        "sortBy": [
          {
            "desc": false,
            "displayName": "២. ប្រសិនបើយុវវ័យមានសិ"
          }
        ]
      },
      "pluginVersion": "10.1.4",
      "targets": [
        {
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "DO $$\nDECLARE\n    columns TEXT;\n    sql TEXT;\nBEGIN\n    -- Step 1: Generate the dynamic column list, ordered by display_order\n    WITH ordered_questions AS (\n        SELECT q.name\n        FROM questions q\n        JOIN sections s ON s.id = q.section_id\n        WHERE s.topic_id = 'd56a6a45-9cdc-4af9-b1a6-550e58ad7bde'\n        ORDER BY q.display_order\n    )\n    SELECT STRING_AGG(\n        format('MAX(CASE WHEN q.name = ''%s'' THEN sa.value END) AS \"%s\"', name, name),\n        ', '\n    )\n    INTO columns\n    FROM ordered_questions;\n\n    -- Step 2: Construct the dynamic query\n    sql := format($f$\n        CREATE OR REPLACE VIEW survey_results AS\n        SELECT \n            s.quizzed_at AS \"Survey date\", \n            SUM(sa.value::integer) AS \"Total Score\",\n            %s\n        FROM survey_answers sa\n        JOIN questions q ON q.id = sa.question_id\n        JOIN surveys s ON s.id = sa.survey_id\n        JOIN app_users u ON u.id = s.app_user_id\n        LEFT JOIN app_user_characteristics ac ON ac.app_user_id = u.id\n        WHERE \n            s.topic_id = 'd56a6a45-9cdc-4af9-b1a6-550e58ad7bde'\n            AND $__timeFilter(s.quizzed_at)\n            AND u.deleted_at IS NULL\n            AND u.age BETWEEN ${age:raw}\n            AND u.platform IN ($platform)\n            AND COALESCE(u.province_id, '') IN ($province_id)\n            AND COALESCE(u.gender, '') IN (${gender:raw})\n            AND COALESCE(ac.characteristic_id::text, '') IN ($characteristic_id)\n        GROUP BY sa.survey_id, s.quizzed_at;\n    $f$, columns);\n\n    -- Step 3: Execute the dynamic query\n    EXECUTE sql;\nEND $$;\n\n-- Step 4: Query the view\nSELECT * FROM survey_results;\n",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Survey Results",
      "type": "table"
    }
  ],
  "refresh": "",
  "schemaVersion": 38,
  "style": "dark",
  "tags": [],
  "templating": {
    "list": [
      {
        "current": {
          "selected": true,
          "text": [
            "All"
          ],
          "value": [
            "$__all"
          ]
        },
        "definition": "select name_en AS __text, id AS __value  from locations where parent_id is null order by id",
        "hide": 0,
        "includeAll": true,
        "label": "Province",
        "multi": true,
        "name": "province_id",
        "options": [],
        "query": "select name_en AS __text, id AS __value  from locations where parent_id is null order by id",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 0,
        "type": "query"
      },
      {
        "allValue": "-1 AND 99",
        "current": {
          "selected": false,
          "text": "All",
          "value": "$__all"
        },
        "hide": 0,
        "includeAll": true,
        "label": "Age",
        "multi": false,
        "name": "age",
        "options": [
          {
            "selected": true,
            "text": "All",
            "value": "$__all"
          },
          {
            "selected": false,
            "text": "< 10",
            "value": "0 AND 9"
          },
          {
            "selected": false,
            "text": "10 - 14",
            "value": "10 AND 14"
          },
          {
            "selected": false,
            "text": "15 - 17",
            "value": "15 AND 17"
          },
          {
            "selected": false,
            "text": "18 - 25",
            "value": "18 AND 24"
          },
          {
            "selected": false,
            "text": "25 - 30",
            "value": "25 AND 30"
          },
          {
            "selected": false,
            "text": "<= 30",
            "value": "0 AND 30"
          },
          {
            "selected": false,
            "text": "30 - 52",
            "value": "30 AND 52"
          },
          {
            "selected": false,
            "text": "> 52",
            "value": "52 AND 99"
          },
          {
            "selected": false,
            "text": "Anonymous",
            "value": "-1 AND -1"
          }
        ],
        "query": "< 10 : 0 AND 9, 10 - 14 : 10 AND 14, 15 - 17 : 15 AND 17, 18 - 25 : 18 AND 24, 25 - 30 : 25 AND 30, <= 30 : 0 AND 30, 30 - 52 : 30 AND 52,  > 52 : 52 AND 99, Anonymous : -1 AND -1",
        "queryValue": "",
        "skipUrlSync": false,
        "type": "custom"
      },
      {
        "allValue": "",
        "current": {
          "selected": false,
          "text": [
            "All"
          ],
          "value": [
            "$__all"
          ]
        },
        "hide": 0,
        "includeAll": true,
        "label": "Gender",
        "multi": true,
        "name": "gender",
        "options": [
          {
            "selected": true,
            "text": "All",
            "value": "$__all"
          },
          {
            "selected": false,
            "text": "Male",
            "value": "'male'"
          },
          {
            "selected": false,
            "text": "Female",
            "value": "'female'"
          },
          {
            "selected": false,
            "text": "LGBT+",
            "value": "'lgbt'"
          },
          {
            "selected": false,
            "text": "Unknown",
            "value": "'unknown'"
          },
          {
            "selected": false,
            "text": "Anonymous",
            "value": "''"
          }
        ],
        "query": "Male : 'male', Female : 'female', LGBT+ : 'lgbt', Unknown :  'unknown',  Anonymous : ''",
        "queryValue": "",
        "skipUrlSync": false,
        "type": "custom"
      },
      {
        "current": {
          "selected": true,
          "text": [
            "All"
          ],
          "value": [
            "$__all"
          ]
        },
        "definition": "(select name_en AS __text, id::text AS __value  from characteristics) union all (select 'Undefined/Anonymous' AS __text, '' AS __value)",
        "hide": 0,
        "includeAll": true,
        "label": "Profile",
        "multi": true,
        "name": "characteristic_id",
        "options": [],
        "query": "(select name_en AS __text, id::text AS __value  from characteristics) union all (select 'Undefined/Anonymous' AS __text, '' AS __value)",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 0,
        "type": "query"
      },
      {
        "current": {
          "selected": false,
          "text": "All",
          "value": "$__all"
        },
        "hide": 0,
        "includeAll": true,
        "label": "Platform",
        "multi": false,
        "name": "platform",
        "options": [
          {
            "selected": true,
            "text": "All",
            "value": "$__all"
          },
          {
            "selected": false,
            "text": "Android",
            "value": "1"
          },
          {
            "selected": false,
            "text": "iOs",
            "value": "2"
          }
        ],
        "query": "Android : 1, iOs : 2",
        "queryValue": "",
        "skipUrlSync": false,
        "type": "custom"
      }
    ]
  },
  "time": {
    "from": "now-3y",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "",
  "title": "Youth Health Dashboard",
  "uid": "I_U7-bi4z",
  "version": 1,
  "weekStart": ""
}
